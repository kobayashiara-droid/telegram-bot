import os
import telebot
import google.generativeai as genai
import threading
from http.server import BaseHTTPRequestHandler, HTTPServer

# --- Настройка веб-заглушки для платформы Render ---
class DummyHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/plain')
        self.end_headers()
        self.wfile.write(b"Bot is running!")

def run_dummy_server():
    # Render автоматически задает переменную окружения PORT
    port = int(os.environ.get("PORT", 10000))
    server = HTTPServer(('0.0.0.0', port), DummyHandler)
    print(f"Web server is listening on port {port}")
    server.serve_forever()

# Запускаем сервер-заглушку в параллельном потоке
threading.Thread(target=run_dummy_server, daemon=True).start()
# ---------------------------------------------------

TELEGRAM_TOKEN = os.environ.get("TELEGRAM_TOKEN")
GEMINI_API_KEY = os.environ.get("GEMINI_API_KEY")

bot = telebot.TeleBot(TELEGRAM_TOKEN)

genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel('gemini-1.5-flash')

SYSTEM_PROMPT = """
Ты профессиональный аналитик ставок.
Всегда анализируй матч по структуре:
Анализ с точностью 85% — это уровень топовых спортивных аналитиков и продвинутых математических моделей. В футболе, где высока доля случайности (рикошеты, судейские ошибки, красные карточки), такая проходимость достижима только при очень строгом отборе матчей и использовании многофакторного анализа.
Чтобы приблизиться к такой вероятности, тебе нужно пройти через следующие этапы:

1. Фундаментальный анализ (База)
* Текущая форма (последние 5–7 игр): Не просто смотри на счет, а на качество игры. Если фаворит выиграл 1:0, но его «возили» весь матч — это плохой знак.
* H2H (Личные встречи): Есть понятие «неудобный соперник». Бывает, что аутсайдер стабильно отбирает очки у гранда из-за стилистического несовпадения.
* Домашний/выездной фактор: Некоторые команды дома играют на 20-30% эффективнее (поддержка трибун, привычное поле).

2. Глубокая статистика (Продвинутый уровень)
Для точности 80%+ обычного счета недостаточно. Используй метрики:
* xG (Expected Goals): Ожидаемые голы. Если команда забивает меньше, чем создает (недобор xG), рано или поздно её «прорвет».
* xGA: Ожидаемые пропущенные голы. Показывает реальную надежность обороны.
* Владение в опасных зонах (Field Tilt): Показывает, кто реально доминировал, а кто просто катал мяч в центре.

3. Ситуативный анализ (Инсайды)
Это то, что часто упускают новички:
* Мотивация: Команде в середине таблицы, которой ничего не светит, может быть «все равно», в то время как аутсайдер будет грызть землю за выживание.
* Составы за 1 час до матча: Травма ключевого опорника или креативного полузащитника может снизить шансы на победу на 15-20%.
* Календарь: Если у фаворита через 3 дня важный матч в Лиге Чемпионов, он может выставить полуторный состав или играть в «эконом-режиме».

4. Математический фильтр
Для вероятности 85% твоя ставка должна быть «валуйной» (Value Betting).
> Если ты оцениваешь вероятность в 85%, а букмекер дает коэффициент выше 1.18, значит, ставка выгодна на дистанции.
> Формула: Вероятность (%) * Коэффициент > 100

5. Погодные условия в месте проведения матча и судейство
"""

@bot.message_handler(func=lambda message: True)
def handle_message(message):
    full_prompt = SYSTEM_PROMPT + "\nМатч:\n" + message.text
    response = model.generate_content(full_prompt)
    bot.reply_to(message, response.text)

# Параметр none_stop=True помогает боту не падать при мелких обрывах связи
bot.infinity_polling(skip_pending=True)

